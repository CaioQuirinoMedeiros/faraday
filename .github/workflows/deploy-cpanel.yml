name: Build & Deploy (tar over SSH with ssh-agent unlocking)

on:
  push:
    branches: [ "main" ]    # change if needed

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: cpanel
    env:
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_PORT: ${{ secrets.SSH_PORT }}
      REMOTE_DIR: ${{ secrets.REMOTE_DIR }}
      REMOTE_TMP_DIR: ${{ secrets.REMOTE_TMP_DIR }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install dependencies
        run: npm ci

      - name: Build & export (Next static)
        run: npm run build

      - name: Prepare SSH tooling (install expect)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y expect
      
      - name: Write encrypted private key safely
        run: |
          mkdir -p ~/.ssh
          umask 077
          printf "%s" "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ls -la ~/.ssh

      - name: Start ssh-agent and add encrypted key using expect
        id: add_key
        run: |
          ls -la ~/.ssh
          eval "$(ssh-agent -s)"

          /usr/bin/expect <<'EOF'
          set timeout 20
          spawn ssh-add ~/.ssh/deploy_key
          expect {
            "Enter passphrase for*" {
              send "$env(SSH_PASSPHRASE)\r"
              exp_continue
            }
            eof
          }
          EOF

          ssh-add -l
        env:
          SSH_PASSPHRASE: ${{ secrets.SSH_PASSPHRASE }}
   
      - name: Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p $SSH_PORT $SSH_HOST >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: "Ensure remote tmp is fresh"
        run: |
          ssh -p $SSH_PORT -o StrictHostKeyChecking=yes $SSH_USER@$SSH_HOST "rm -rf '$REMOTE_TMP_DIR' && mkdir -p '$REMOTE_TMP_DIR'"

      - name: Stream tar.gz to remote tmp
        run: |
          tar -C out -czf - . | ssh -p $SSH_PORT -o StrictHostKeyChecking=yes $SSH_USER@$SSH_HOST "tar -xzf - -C '$REMOTE_TMP_DIR'"

      - name: Atomic swap
        run: |
          ssh -p $SSH_PORT -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "set -euo pipefail
          BACKUP_DIR='${REMOTE_DIR}_backup'
          # ensure target exists or not
          if [ -d '${REMOTE_DIR}' ]; then
            mv '${REMOTE_DIR}' \"\$BACKUP_DIR\"
          fi
          # move tmp into place
          mv '${REMOTE_TMP_DIR}' '${REMOTE_DIR}'
          # cleanup: remove zip if present and temp if any
          rm -rf '${REMOTE_TMP_DIR}'
          exit 0"